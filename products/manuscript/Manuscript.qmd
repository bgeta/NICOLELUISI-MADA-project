---
title: "MADA 8060E Project"
subtitle: "Trends in New HIV Diagnoses in the US, 2008-2022"
author: Nicole Luisi
date: "`r Sys.Date()`"
format:
  html:
    self-contained: true
    toc: false
    number-sections: true
    highlight-style: github
bibliography: ../dataanalysis_template_references.bib
csl: ../apa.csl
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# load R packages
library(here) 
library(ggplot2)
library(skimr) 
library(plotly)
library(gt)
library(knitr)
library(readxl)
library(dplyr)
library(kableExtra)
library(gridExtra)
library(ggpubr)
```

# Summary/Abstract

The purpose of this analysis is to analyze US trends in new HIV diagnoses over the past 10 years. Previous research by [Chapin-Bardales et al. (2017)](https://doi.org/10.1016/j.annepidem.2017.04.002) evaluated trends in AIDS diagnosis rates by race/ethnicity between 1984-2013. This analysis will focus on new HIV diagnoses between 2008-2022; subgroups will include region, age group, gender, and race/ethnicity. [@Chapin2017]

# Introduction 

## General Background Information
_Provide enough background on your topic that others can understand the why and how of your analysis_ 

## Description of data and data source

**Data Source**:

*Note: New diagnoses data are currently only available through 2020 on AIDSVu and CDC Atlas. If 2021-2022 data are not available by the time the analysis needs to be completed, the analysis will be temporarily restricted to 2012-2020.*

* HIV New Diagnoses: [AIDSVu](https://aidsvu.org/) [@Sullivan2020] 
    
**Analysis**:

* Rate (per 100,000) of new HIV diagnoses by age, gender, and race/ethnicity (national, regional)
* Rate ratios for new HIV diagnoses by age, gender, and race/ethnicity (national, regional)
* Average annual percent change (AAPC) for incidence (calculated using [Joinpoint Regression Software (Version 4.9.1.0)](https://surveillance.cancer.gov/help/joinpoint/tech-help/citation))

## Questions/Hypotheses to be addressed
This analysis will evaluate national and regional trends in HIV new diagnoses between 2008-2020 by sex, age, and race/ethnicity. 

{{< pagebreak >}}

# Methods 

## Data aquisition
Data files were downloaded from [AIDSVu](https://aidsvu.org/) and placed in `data/raw_data/AIDSVu` sub-folders. The new diagnosis files consist of one xlsx file per year for each level (national, regional, etc.). 

## Data import and cleaning
The `processingcode.R` file includes the following steps:

* Read in xlsx data files and combine all years for each level
* Subset variables of interest and rename variables so all levels are consistent 
* View/explore data
* Calculate new rate ratio variables for subgroups (White=ref)
* Prepare combined national and regional file with all variables

The `analysis.qmd` file includes the following steps:

* Read in result data from external Joinpoint analyses
* Clean and combine Joinpoint analysis results
* View/explore data
* Create tables and plots of results

## Statistical analysis
Rate ratios for race/ethnicity were calculated by dividing the new diagnosis rate for each group by the new diagnosis rate for the reference group (non-Hispanic White).

[Joinpoint Regression Software (Version 4.9.1.0)](https://surveillance.cancer.gov/help/joinpoint/tech-help/citation) was used to test for significant joinpoints (years) to identify  trends in new diagnoses rates, nationally and regionally, by sex, age, and race/ethnicity. Trends for rate ratios were also used to assess disparities by race/ethnicity over time. For Joinpoint analyses, the maximum number of joinpoints was set to 3, and standard errors were auto-calculated by the tool under the heteroscedasticity assumption. The average annual percent changes (AAPCs) from 2008-2020 were also calculated for all subsets.

{{< pagebreak >}}

# Results

## Descriptive analysis

@fig-natplotsex shows line plot for national new diagnosis rates by sex.

```{r}
#| label: fig-natplotsex
#| fig-cap: "National new diagnosis rates by sex"
#| echo: FALSE
knitr::include_graphics(here("results","US_rates_bysex.png"))
```

@fig-natplotage shows line plot for national new diagnosis rates by age group.

```{r}
#| label: fig-natplotage
#| fig-cap: "National new diagnosis rates by age group"
#| echo: FALSE
knitr::include_graphics(here("results","US_rates_byage.png"))
```

@fig-natplotrace shows line plot for national new diagnosis rates by race/ethnicity.

```{r}
#| label: fig-natplotrace
#| fig-cap: "National new diagnosis rates by race/ethnicity"
#| echo: FALSE
knitr::include_graphics(here("results","US_rates_byrace.png"))
```

Trends by sex and age group are as expected. For sex and age, all rates have declined between 2008-2020 and groups with the highest incidence had the steepest declines over time, particularly after 2016. The remainder of this analysis will focus on trends and disparities by race/ethnicity.

@fig-regplotrace shows a bubble plot comparing regional new diagnosis (log) rates by race/ethnicity. The color represents race/ethnicity and the size of the point represents the log of the new diagnosis rate. 

```{r}
#| label: fig-regplotrace
#| fig-cap: "Regional new diagnosis rate (log) by race/ethnicity"
#| echo: FALSE
knitr::include_graphics(here("results","racerates_region.png"))
```

@fig-natplotraceratios shows national plot of log race ratios for new diagnoses (White=ref).

```{r}
#| label: fig-natplotraceratios
#| fig-cap: "National race ratios"
#| echo: FALSE
knitr::include_graphics(here("results","racerates_allUS.png"))
```

@fig-natplotdiffbwh shows national plot of White-Black and White-Hispanic rate differences by year.

```{r}
#| label: fig-natplotdiffbwh
#| fig-cap: "White-Black and White-Hispanic differences in national new diagnosis rate"
#| echo: FALSE
knitr::include_graphics(here("results","nat_diff_bwh.png"))
```

@tbl-allrates shows a full summary of new diagnosis rates for all US by group.

```{r}
#| label: tbl-allrates
#| tbl-cap: "All US New diagnosis Rates"
#| echo: FALSE
resulttable=readRDS(here("results","all_us_rates.rds"))
kable(resulttable,caption = "All US New Diagnosis Rates", col.names=c("Year", "Overall", "Male", "Female", "Black", "White", "Hispanic", "Asian", "American Indian/Alaska Native", "Multiracial", "Native Hawaiian/Pacific Islander", "Age 13-24", "Age 25-34", "Age 35-44", "Age 45-54", "Age 55+"), align="rc") %>% 
  row_spec(row = 0, color = "white", background = "#004987") %>% kable_styling(full_width=T, bootstrap_options = "striped", font_size=10)  
```

## Statistical analysis

@tbl-allaapc shows a summary of average annual percent change (AAPC) for each subgroup and geographic region.

```{r}
#| label: tbl-allaapc
#| tbl-cap: "All AAPCs"
#| echo: FALSE
resulttable=readRDS(here("results","aapc_all_results.rds"))
kable(resulttable,caption = "All AAPC Results", 
      col.names=c("Stratification", "Geographic Area", "AAPC", "AAPC_lCI", "AAPC_uCI", "p-value"),      align="rc") %>% 
  row_spec(row = 0, color = "white", background = "#004987") %>% kable_styling(full_width=T, bootstrap_options = "striped", font_size=10) %>% 
  pack_rows("Overall", 1, 5) %>%
  pack_rows("Female", 6, 10) %>%
  pack_rows("Male", 11, 15) %>%
  pack_rows("Age 13-24", 16, 20) %>%
  pack_rows("Age 25-34", 21, 25) %>%
  pack_rows("Age 35-44", 26, 30)  %>%
  pack_rows("Age 45-54", 31, 35)  %>%
  pack_rows("Age 55+", 36, 40)  %>%
  pack_rows("American Indian/Alaska Native", 41, 44) %>%
  pack_rows("Asian", 45, 49) %>%
  pack_rows("Black", 50, 54) %>%
  pack_rows("Hispanic", 55, 59) %>%
  pack_rows("Multiracial", 60, 64) %>%
  pack_rows("Native Hawaiian/Pacific Islander", 65, 67) %>%
  pack_rows("White", 68, 72) %>%
  pack_rows("AIAN-White", 73, 76) %>%
  pack_rows("Asian-White", 77, 81) %>%
  pack_rows("Black-White", 82, 86) %>%
  pack_rows("Hispanic-White", 87, 91) %>%
  pack_rows("Multi-White", 92, 96) %>%
  pack_rows("NHPI-White", 97, 99) 
```

@tbl-allapc shows a full summary of annual percent change (APC) for each segment of time within each subgroup and geographic region.

```{r}
#| label: tbl-allapc
#| tbl-cap: "All APCs"
#| echo: FALSE
resulttable=readRDS(here("results","apc_all_results.rds"))
kable(resulttable,caption = "All APC Results", align="rc") %>% 
  row_spec(row = 0, color = "white", background = "#004987") %>% kable_styling(full_width=T, bootstrap_options = "striped", font_size=10) %>% 
  pack_rows("Overall", 1, 15) %>%
  pack_rows("Female", 16, 24) %>%
  pack_rows("Male", 25, 32) %>%
  pack_rows("Age 13-24", 33, 41) %>%
  pack_rows("Age 25-34", 42, 54) %>%
  pack_rows("Age 35-44", 55, 63)  %>%
  pack_rows("Age 45-54", 64, 70)  %>%
  pack_rows("Age 55+", 71, 76)  %>%
  pack_rows("American Indian/Alaska Native", 77, 80) %>%
  pack_rows("Asian", 81, 90) %>%
  pack_rows("Black", 91, 102) %>%
  pack_rows("Hispanic", 103, 113) %>%
  pack_rows("Multiracial", 114, 120) %>%
  pack_rows("Native Hawaiian/Pacific Islander", 121, 123) %>%
  pack_rows("White", 124, 130) %>%
  pack_rows("AIAN-White", 131, 134) %>%
  pack_rows("Asian-White", 135, 142) %>%
  pack_rows("Black-White", 143, 147) %>%
  pack_rows("Hispanic-White", 148, 156) %>%
  pack_rows("Multi-White", 157, 165) %>%
  pack_rows("NHPI-White", 166, 168) 
```

@fig-natplotbwhjpoint shows national plot of new diagnosis Joinpoints for race/ethnicity (Black, White, Hispanic).

```{r}
#| label: fig-natplotbwhjpoint
#| fig-cap: "National Joinpoint results comparing Black, White, Hispanic"
#| echo: FALSE
knitr::include_graphics(here("results","raceBWH_joinpoints_allUS.png"))
```

@fig-natplotraceratioaapc shows regional plot of new diagnosis AAPCs for race/ethnicity.

```{r}
#| label: fig-natplotraceratioaapc
#| fig-cap: "Regional Joinpoint AAPC results by race/ethnicity"
#| echo: FALSE
knitr::include_graphics(here("results","raceratio_byregion.png"))
```


{{< pagebreak >}}


# Discussion

## Summary and Interpretation
_Summarize what you did, what you found and what it means._

## Strengths and Limitations
_Discuss what you perceive as strengths and limitations of your analysis._

## Conclusions
_What are the main take-home messages?_


{{< pagebreak >}}

## References



